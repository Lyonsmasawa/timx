{% extends "main.html" %}
{% load bootstrap5 %}
{% load template_filters %}

{% block content %}
{% include 'res_nav.html' %}

<div class="container-fluid p-0 pt-2 part-upper" style="height: 100%;">
    <div class="d-flex justify-content-between align-items-center py-0 pt-3 px-4  part-upper">
        <!-- Nav tabs for switching between sections -->
        <ul class="nav nav-tabs" id="organizationTab" role="tablist">
            <li class="nav-item" role="presentation">
                <a class="nav-link  active" id="customers-tab" data-bs-toggle="tab" href="#customers" role="tab"
                    aria-controls="customers" aria-selected="true">Customers</a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" id="items-tab" data-bs-toggle="tab" href="#items" role="tab" aria-controls="items"
                    aria-selected="false">Items</a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" id="sales-tab" data-bs-toggle="tab" href="#sales" role="tab" aria-controls="sales"
                    aria-selected="false">Sales</a>
            </li>

            <li class="nav-item" role="presentation">
                <a class="nav-link" id="credit-note-tab" data-bs-toggle="tab" href="#credit-note" role="tab"
                    aria-controls="credit-note" aria-selected="false">Credit Note</a>
            </li>

            <li class="nav-item" role="presentation">
                <a class="nav-link" id="purchases-tab" data-bs-toggle="tab" href="#purchases" role="tab"
                    aria-controls="purchases" aria-selected="false">Purchases</a>
            </li>
        </ul>
        <h4 class="text-muted weight-bold">Organization: {{ organization.organization_name }}</h4>

    </div>
    <div class="container-fluid py-3 " style="min-height: 90vh; background-color:white;">
        <div class="tab-content add-tab" id="organizationTabContent">
            <!-- Customers tab -->
            <div class="tab-pane fade show active" id="customers" role="tabpanel" aria-labelledby="customers-tab">
                <h3></h3>
                <div class="d-flex justify-content-between align-items-center p-0 pt-1">
                    <h3><span style="color: #000000;">{{ customers.count }}</span> Customers</h3>
                    <div>
                        <button type="button" class="btn add" data-toggle="modal" data-bs-toggle="modal"
                            data-bs-target="#createCustomerModal">
                            + New Customer
                        </button>
                    </div>
                </div>
                <hr class="hr-style" />
                <ul class="list-group customer-list"></ul>
                {% if customers %}
                <table class="table table-striped">
                    <thead class="thead-dark">
                        <tr>
                            <th scope="col">#</th>
                            <th scope="col">Name</th>
                            <th scope="col">Pin</th>
                            <th scope="col">Phone</th>
                            <th scope="col">Email</th>
                            <th scope="col">Address</th>
                            <th scope="col">Status</th>
                            <th scope="col">Actions</th>
                        </tr>

                    </thead>
                    <tbody class="cust-list">
                        {% for customer in customers %}
                        <tr id="customer-{{ customer.id }}" class="align-items-center justify-center lines">
                            <td>{{forloop.counter}}</td>

                            <td>
                                <strong>{{ customer.customer_name }}</strong>
                            </td>
                            <td> {{ customer.customer_pin }} </td>
                            <td>{{ customer.customer_phone }}</td>
                            <td>{{ customer.customer_email }}</td>
                            <td>{{ customer.customer_address }}</td>
                            <td class="dflex">
                                {% with customer_data=customer_statuses|dict_get:customer.id %}
                                <span class="status {{ customer_data.status }}">{{ customer_data.status }}</span>

                                {% if customer_data.status == "failed" %}
                                <button class="btn retry-request r-btn" data-type="saveCustomer"
                                    data-url="{% url 'organization:retry_failed_request' 'saveCustomer' customer.id %}"
                                    data-id="{{ customer_data.id }}">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" fill="currentColor"
                                        class="bi bi-repeat" viewBox="0 0 22 22">
                                        <path
                                            d="M11 5.466V4H5a4 4 0 0 0-3.584 5.777.5.5 0 1 1-.896.446A5 5 0 0 1 5 3h6V1.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384l-2.36 1.966a.25.25 0 0 1-.41-.192m3.81.086a.5.5 0 0 1 .67.225A5 5 0 0 1 11 13H5v1.466a.25.25 0 0 1-.41.192l-2.36-1.966a.25.25 0 0 1 .41.192V12h6a4 4 0 0 0 3.585-5.777.5.5 0 0 1 .225-.67Z" />
                                    </svg>
                                </button>
                                {% endif %}
                                {% endwith %}
                            </td>

                            <td>
                                <div class="dropdown">
                                    <button class="btn btn-secondary btn-sm dropdown-toggle a-btn" type="button"
                                        id="dropdownMenuButton-customer-{{ customer.id }}" data-bs-toggle="dropdown"
                                        aria-expanded="false">
                                        Actions
                                    </button>
                                    <ul class="dropdown-menu"
                                        aria-labelledby="dropdownMenuButton-customer-{{ customer.id }}">
                                        <li>
                                            <a href="#" class="dropdown-item py-0 my-0" data-bs-toggle="modal"
                                                data-bs-target="#editModal-{{ customer.id }}">Edit</a>
                                        </li>
                                        <hr style="height: 0.25px;">
                                        <li>
                                            <a href="#" class="dropdown-item text-danger py-0 my-0"
                                                data-bs-toggle="modal"
                                                data-bs-target="#deleteModal-{{ customer.id }}">Delete</a>
                                        </li>
                                    </ul>
                                </div>
                            </td>
                        </tr>


                        <!-- Edit Modal -->
                        <div class="modal fade" id="editModal-{{ customer.id }}" tabindex="-1"
                            aria-labelledby="editModalLabel-{{ customer.id }}" aria-hidden="true">
                            <div class="modal-dialog  modal-dialog-centered">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="editModalLabel-{{ customer.id }}">Edit Customer</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"
                                            aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <!-- Add edit form here -->
                                        <form id="editForm-{{ customer.id }}" method="POST"
                                            action="{% url 'customer:customer_update' customer.id %}">
                                            <div id="cust-edit-form-errors" class="alert alert-danger d-none">
                                                <!-- Error messages will be inserted here -->
                                            </div>
                                            {% csrf_token %}
                                            <div class="mb-3">
                                                <label for="customerName" class="form-label">Customer Name</label>
                                                <input type="text" class="form-control"
                                                    id="customerName-{{ customer.id }}" name="customer_name"
                                                    value="{{ customer.customer_name }}">
                                            </div>
                                            <div class="mb-3">
                                                <label for="customerEmail" class="form-label">Customer Email</label>
                                                <input type="email" class="form-control"
                                                    id="customerEmail-{{ customer.id }}" name="customer_email"
                                                    value="{{ customer.customer_email }}">
                                            </div>
                                            <div class="mb-3">
                                                <label for="customerAddress" class="form-label">Customer Address</label>
                                                <input type="text" class="form-control"
                                                    id="customerAddress-{{ customer.id }}" name="customer_address"
                                                    value="{{ customer.customer_address }}">
                                            </div>
                                            <div class="mb-3">
                                                <label for="customerPhone" class="form-label">Customer Phone</label>
                                                <input type="text" class="form-control"
                                                    id="customerPhone-{{ customer.id }}" name="customer_phone"
                                                    value="{{ customer.customer_phone }}">
                                            </div>
                                            <div class="text-center">
                                                <button type="button" class="btn btn-primary w-btn"
                                                    onclick="submitEditForm(event, '{{customer.id}}')">
                                                    Save Changes
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Delete Modal -->
                        <div class="modal fade" id="deleteModal-{{ customer.id }}" tabindex="-1"
                            aria-labelledby="deleteModalLabel-{{ customer.id }}" aria-hidden="true">
                            <div class="modal-dialog  modal-dialog-centered">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title text-danger" id="deleteModalLabel-{{ customer.id }}">
                                            Delete Customer </h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"
                                            aria-label="Close"></button>
                                    </div>
                                    <div id="delete-form-errors" class="alert alert-danger d-none">
                                        <!-- Error messages will be inserted here -->
                                    </div>
                                    <div class="modal-body">
                                        Are you sure you want to delete <strong>{{ customer.customer_name }}</strong>?
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn cancel" data-bs-dismiss="modal">Cancel</button>
                                        <form method="POST" action="{% url 'customer:customer_delete' customer.id %}"
                                            id="deleteForm-{{ customer.id }}">
                                            {% csrf_token %}
                                            <button type="submit" class="btn delete"
                                                onclick="submitDeleteForm(event, '{{customer.id}}')">
                                                Delete</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p>No customers found for this organization.</p>
                {% endif %}

            </div>

            <!-- Items tab -->
            <div class="tab-pane fade" id="items" role="tabpanel" aria-labelledby="items-tab">
                <h3></h3>
                <div class="d-flex justify-content-between align-items-center p-0 pt-1">
                    <h3><span style="color: #000000;">{{ items.count }}</span> Items</h3>
                    <div>
                        <button type="button" class="btn add" data-toggle="modal" data-bs-toggle="modal"
                            data-bs-target="#createItemModal">
                            + New Item
                        </button>

                    </div>
                </div>
                <hr class="hr-style" />
                <ul class="list-group item-list"></ul>
                {% if items %}
                <table class="table table-striped">
                    <thead class="thead-dark">
                        <tr>
                            <th scope="col">#</th>
                            <th scope="col">Item</th>
                            <th scope="col">itemCd</th>
                            <th scope="col">Class</th>
                            <th scope="col">Tax Code</th>
                            <th scope="col">Balance</th>
                            <th scope="col">Status</th>
                            <th scope="col">Actions</th>
                        </tr>

                    </thead>
                    <tbody class="it-list">
                        {% for item in items %}
                        <tr id="item-{{ item.id }}" class="align-items-center justify-center lines">
                            <td>{{forloop.counter}}</td>
                            <td>
                                <strong>{{ item.item_name }}</strong>
                            </td>
                            <td>{{ item.itemCd }}</td>
                            <td>{{ item.item_class_code }}</td>
                            <td>{{ item.item_tax_code }}</td>
                            <td>{{ item.item_current_balance }}</td>

                            <td class="dflex">
                                {% with item_data=item_statuses|dict_get:item.id %}
                                <span class="status {{ item_data.status }}">{{ item_data.status }}</span>

                                {% if item_data.status == "failed" %}
                                <button class="btn retry-request r-btn" data-type="saveItem"
                                    data-url="{% url 'organization:retry_failed_request' 'saveItem' item.id %}"
                                    data-id="{{ item_data.id }}">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="15" height="15" fill="currentColor"
                                        class="bi bi-repeat" viewBox="0 0 20 20">
                                        <path
                                            d="M11 5.466V4H5a4 4 0 0 0-3.584 5.777.5.5 0 1 1-.896.446A5 5 0 0 1 5 3h6V1.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384l-2.36 1.966a.25.25 0 0 1-.41-.192m3.81.086a.5.5 0 0 1 .67.225A5 5 0 0 1 11 13H5v1.466a.25.25 0 0 1-.41.192l-2.36-1.966a.25.25 0 0 1 .41.192V12h6a4 4 0 0 0 3.585-5.777.5.5 0 0 1 .225-.67Z" />
                                    </svg>
                                </button>
                                {% endif %}
                                {% endwith %}
                            </td>


                            <td>
                                <div class="dropdown">
                                    <button class="btn btn-secondary btn-sm dropdown-toggle a-btn" type="button"
                                        id="dropdownMenuButton-item-{{ item.id }}" data-bs-toggle="dropdown"
                                        aria-expanded="false">
                                        Actions
                                    </button>
                                    <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton-item-{{ item.id }}">
                                        <li class=" w-100 py-0 my-0">
                                            <button class="dropdown-item py-0 my-0" data-bs-toggle="modal"
                                                data-bs-target="#updateQuantityModal" data-item-id="{{ item.id }}"
                                                data-item-name="{{ item.item_name }}"
                                                data-item-quantity="{{ item.item_quantity }}">
                                                Update Quantity
                                            </button>
                                        </li>
                                        <hr>
                                        <li class=" w-100 py-0 my-0">
                                            <button class="dropdown-item py-0 my-0" data-bs-toggle="modal"
                                                data-bs-target="#itemCompositionModal-{{ item.id }}">
                                                Item Composition
                                            </button>
                                        </li>
                                        <hr>
                                        <li class="py-0 my-0">
                                            <a href="#" class="dropdown-item text-danger py-0 my-0"
                                                data-bs-toggle="modal"
                                                data-bs-target="#deleteModalItem-{{ item.id }}">Delete</a>
                                        </li>
                                    </ul>
                                </div>
                            </td>
                        </tr>



                        <!-- Update Quantity Modal -->
                        <div class="modal fade" id="updateQuantityModal" tabindex="-1"
                            aria-labelledby="updateQuantityModalLabel" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-centered modal-part">
                                <div class="modal-content">
                                    <form id="updateQuantityForm" method="POST"
                                        action="{% url 'item:update_quantity' %}">
                                        {% csrf_token %}
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="updateQuantityModalLabel">Update Quantity</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                aria-label="Close"></button>
                                        </div>
                                        <div id="item-update-form-errors" class="alert alert-danger d-none">
                                            <!-- Error messages will be inserted here -->
                                        </div>
                                        <div class="modal-body">
                                            <input type="hidden" id="itemId" name="item_id">
                                            <div class="mb-3">
                                                <label for="itemName" class="form-label">Item Name</label>
                                                <input type="text" id="itemName" class="form-control" readonly>
                                            </div>
                                            <div class="mb-3">
                                                <label for="movementType" class="form-label">Movement Type</label>
                                                <select id="movementType" name="movement_type" class="form-select"
                                                    required>
                                                    <option value="">-- Select Movement Type --</option>
                                                    <option value="ADD">Add Stock</option>
                                                    <option value="REMOVE">Reduce Stock</option>
                                                </select>
                                            </div>
                                            <div class="mb-3">
                                                <label for="movementReason" class="form-label">Movement Reason</label>
                                                <select id="movementReason" name="movement_reason" class="form-select"
                                                    required>
                                                    <option value="">-- Select Movement Reason --</option>
                                                </select>
                                            </div>
                                            <div class="mb-3">
                                                <label for="itemQuantity" class="form-label">Quantity</label>
                                                <input type="number" id="itemQuantity" name="item_quantity"
                                                    class="form-control" required>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn cancel"
                                                data-bs-dismiss="modal">Cancel</button>
                                            <button type="submit" class="btn btn-primary w-btn">Update Quantity</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>


                        <!-- Edit Modal -->
                        <div class="modal fade" id="editModalItem-{{ item.id }}" tabindex="-1"
                            aria-labelledby="editModalLabelItem-{{ item.id }}" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-centered modal-part">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="editModalLabelItem-{{ item.id }}">Edit Item</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"
                                            aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <form method="POST" action="{% url 'item:item_update' item.id %}"
                                            id="updateItemForm-{{ item.id }}">
                                            {% csrf_token %}
                                            <div id="item-edit-form-errors" class="alert alert-danger d-none">
                                                <!-- Error messages will be inserted here -->
                                            </div>
                                            <div class="row g-3">
                                                <!-- Item Name -->
                                                <div class="col-md-6">
                                                    <label for="itemName" class="form-label">Item Name</label>
                                                    <input type="text" class="form-control" id="itemName"
                                                        name="item_name" value="{{ item.item_name }}">
                                                </div>

                                                <!-- Origin Nation Code -->
                                                <div class="col-md-6">
                                                    <label for="originNationCode" class="form-label">Origin Nation
                                                        Code</label>
                                                    <select id="originNationCode" name="origin_nation_code"
                                                        class="form-select">
                                                        {% for code, label in COUNTRY_CHOICES %}
                                                        <option value="{{ code }}">
                                                            {{ label }}
                                                        </option>
                                                        {% endfor %}
                                                    </select>
                                                </div>

                                                <!-- Item Type Code -->
                                                <div class="col-md-6">
                                                    <label for="itemTypeCode" class="form-label">Item Type Code</label>
                                                    <select id="itemTypeCode" name="item_type_code" class="form-select">
                                                        {% for code, label in PRODUCT_TYPE_CHOICES %}
                                                        <option value="{{ code }}">
                                                            {{ label }}
                                                        </option>
                                                        {% endfor %}
                                                    </select>
                                                </div>

                                                <!-- Quantity Unit Code -->
                                                <div class="col-md-6">
                                                    <label for="quantityUnitCode" class="form-label">Quantity Unit
                                                        Code</label>
                                                    <select id="quantityUnitCode" name="quantity_unit_code"
                                                        class="form-select">
                                                        {% for code, label in UNIT_CHOICES %}
                                                        <option value="{{ code }}">
                                                            {{ label }}
                                                        </option>
                                                        {% endfor %}
                                                    </select>
                                                </div>

                                                <!-- Package Unit Code -->
                                                <div class="col-md-6">
                                                    <label for="packageUnitCode" class="form-label">Package Unit
                                                        Code</label>
                                                    <select id="packageUnitCode" name="package_unit_code"
                                                        class="form-select">
                                                        {% for code, label in PACKAGE_CHOICES %}
                                                        <option value="{{ code }}">
                                                            {{ label }}
                                                        </option>
                                                        {% endfor %}
                                                    </select>
                                                </div>

                                                <!-- Item Class Code -->
                                                <div class="col-md-6">
                                                    <label for="itemClassCode" class="form-label">Item Class
                                                        Code</label>
                                                    <select id="itemClassCode" name="item_class_code"
                                                        class="form-select">
                                                        {% for code, label in TAXPAYER_STATUS_CHOICES %}
                                                        <option value="{{ code }}">
                                                            {{ label }}
                                                        </option>
                                                        {% endfor %}
                                                    </select>
                                                </div>

                                                <!-- Item Tax Code -->
                                                <div class="col-md-6">
                                                    <label for="itemTaxCode" class="form-label">Item Tax Code</label>
                                                    <select id="itemTaxCode" name="item_tax_code" class="form-select">
                                                        {% for code, label in TAX_TYPE_CHOICES %}
                                                        <option value="{{ code }}">
                                                            {{ label }}
                                                        </option>
                                                        {% endfor %}
                                                    </select>
                                                </div>

                                                <!-- Item Opening Balance -->
                                                <div class="col-md-6">
                                                    <label for="itemOpeningBalance" class="form-label">Opening
                                                        Balance</label>
                                                    <input type="number" class="form-control" readonly disabled
                                                        id="itemOpeningBalance" name="item_opening_balance" step="0.01"
                                                        value="{{ item.item_opening_balance }}">
                                                </div>

                                                <!-- Item Current Balance -->
                                                <div class="col-md-6">
                                                    <label for="itemCurrentBalance" class="form-label">Current
                                                        Balance</label>
                                                    <input type="number" readonly disabled class="form-control"
                                                        id="itemCurrentBalance" name="item_current_balance" step="0.01"
                                                        value="{{ item.item_current_balance }}">
                                                </div>

                                                <!-- Item System ID -->
                                                <div class="col-md-6">
                                                    <label for="itemSystemId" class="form-label">System ID</label>
                                                    <input type="text" class="form-control" id="itemSystemId"
                                                        name="item_system_id" value="{{ item.item_system_id }}">
                                                </div>

                                                <!-- Item System Name -->
                                                <div class="col-md-6">
                                                    <label for="itemSystemName" class="form-label">System Name</label>
                                                    <input type="text" class="form-control" id="itemSystemName"
                                                        name="item_system_name" value="{{ item.item_system_name }}">
                                                </div>
                                            </div>

                                            <div class="text-center mt-5">
                                                <button type="button" class="btn btn-primary w-btn"
                                                    onclick="submitUpdateItemForm(event, '{{item.id}}')">Save
                                                    Changes</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>


                        <!-- Modal for Item Composition -->
                        <div class="modal fade" id="itemCompositionModal-{{ item.id }}" tabindex="-1"
                            aria-labelledby="itemCompositionModalLabel" aria-hidden="true">
                            <div class="modal-dialog modal-md modal-dialog-centered">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="itemCompositionModalLabel">Item Composition for
                                            {{ item.item_name }}</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"
                                            aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <form id="itemCompositionForm-{{ item.id }}" method="POST"
                                            action="{% url 'item:save_item_composition' %}">
                                            {% csrf_token %}
                                            <input type="hidden" name="itemCd" value="{{ item.itemCd }}">
                                            <div class="mb-3">
                                                <label for="cpstItemCd-{{ item.id }}" class="form-label">Select
                                                    Composition Item</label>
                                                <select name="cpstItemCd" id="cpstItemCd-{{ item.id }}"
                                                    class="form-select" required>
                                                    <option value="">Select...</option>
                                                    {% for existing_item in items %}
                                                    <option value="{{ existing_item.itemCd }}">
                                                        {{ existing_item.item_name }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div class="mb-3">
                                                <label for="cpstQty-{{ item.id }}" class="form-label">Composition
                                                    Quantity</label>
                                                <input type="number" name="cpstQty" id="cpstQty-{{ item.id }}"
                                                    class="form-control" required>
                                            </div>
                                            <div class="text-end">
                                                <button type="submit" class="btn btn-primary w-btn">Save
                                                    Composition</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>


                        <!-- Delete Modal -->
                        <div class="modal fade" id="deleteModalItem-{{ item.id }}" tabindex="-1"
                            aria-labelledby="deleteModalLabelItem-{{ item.id }}" aria-hidden="true">
                            <div class="modal-dialog  modal-dialog-centered  modal-part">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title text-danger" id="deleteModalLabelItem-{{ item.id }}">
                                            Delete Item</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"
                                            aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        Are you sure you want to delete <strong>{{ item.item_name }}</strong>?
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn cancel" data-bs-dismiss="modal">Cancel</button>
                                        <form method="POST" action="{% url 'item:item_delete' item.id %}"
                                            id="deleteItemForm-{{ item.id }}">
                                            {% csrf_token %}
                                            <button type="submit" class="btn delete"
                                                onclick="submitDeleteItemForm(event, '{{item.id}}')">
                                                Delete</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p>No items found for this organization.</p>
                {% endif %}
            </div>

            <!-- sales tab -->
            <div class="tab-pane fade" id="sales" role="tabpanel" aria-labelledby="sales-tab">
                <h3></h3>
                <div class="d-flex justify-content-between align-items-center p-0 pt-1">
                    <h3><span style="color: #000000;">{{ invoices.count }}</span> Sales invoices</h3>
                    <div>
                        <a type="button" class="btn add"
                            href="{% url 'sales_items:sales_items_create' organization.id  %}">Add Sale</a>
                    </div>
                </div>
                <hr class="hr-style" />
                <ul class="list-group sales-list"></ul>
                {% if invoices %}
                <table class="table table-striped">
                    <thead class="thead-dark">
                        <tr>
                            <th scope="col">#</th>
                            <th scope="col">InvNo.</th>
                            <th scope="col">Cust Pin</th>
                            <th scope="col">Cust Name</th>
                            <th scope="col">Cust Phone</th>
                            <th class="col">Status</th>
                            <th scope="col">Download</th>
                        </tr>

                    </thead>
                    <tbody>
                        {% for invoice in invoices %}
                        <tr id="invoice-{{ invoice.id }}" class="align-items-center justify-center lines">
                            <td>{{forloop.counter}}</td>
                            <td>{{ invoice.receipt_number }}</td>
                            <td>{{ invoice.customer.customer_pin }}</td>
                            <td>
                                <strong>{{ invoice.customer.customer_name }}</strong>
                            </td>
                            <td>{{ invoice.customer.customer_phone }}</td>
                            <td class="dflex">
                                {% with transaction_data=transaction_statuses|dict_get:invoice.id %}
                                <span class="status {{ transaction_data.status }}">{{ transaction_data.status }}</span>

                                {% if transaction_data.status == "failed" %}
                                <button class="btn retry-request r-btn" data-type="saveTransaction"
                                    data-url="{% url 'organization:retry_failed_request' 'saveTransaction' invoice.id %}"
                                    data-id="{{ transaction_data.id }}">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="15" height="15" fill="transparent"
                                        class="bi bi-repeat" viewBox="0 0 20 20">
                                        <path
                                            d="M11 5.466V4H5a4 4 0 0 0-3.584 5.777.5.5 0 1 1-.896.446A5 5 0 0 1 5 3h6V1.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384l-2.36 1.966a.25.25 0 0 1-.41-.192m3.81.086a.5.5 0 0 1 .67.225A5 5 0 0 1 11 13H5v1.466a.25.25 0 0 1-.41.192l-2.36-1.966a.25.25 0 0 1 .41-.192V12h6a4 4 0 0 0 3.585-5.777.5.5 0 0 1 .225-.67Z" />
                                    </svg>
                                </button>
                                {% endif %}
                                {% endwith %}
                            </td>

                            <td>
                                <div class="d-flex align-items-center">
                                    {% with transaction_data=transaction_statuses|dict_get:invoice.id %}
                                    {% if transaction_data.status == "success" %}

                                    {% if invoice.document_path %}
                                    <button class="btn btn-secondary btn-sm a-btn me-2 view-pdf-btn gap-1"
                                        data-pdf-url="{{ invoice.document_path.url }}" data-bs-toggle="modal"
                                        data-bs-target="#pdfModal">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="15" height="15" fill="white"
                                            class="bi bi-arrow-down-circle text-center" viewBox="0 0 18 18"
                                            style="fill: white;">
                                            <path fill-rule="evenodd"
                                                d="M1 8a7 7 0 1 0 14 0A7 7 0 0 0 1 8m15 0A8 8 0 1 1 0 8a8 8 0 0 1 16 0M8.5 4.5a.5.5 0 0 0-1 0v5.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293z" />
                                        </svg>View PDF
                                    </button>
                                    {% else %}
                                    <a href="{% url 'sales_items:generate_invoice_pdf' transaction_data.id invoice.id %}"
                                        class="btn btn-secondary btn-sm a-btn me-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="15" height="15" fill="white"
                                            class="bi bi-arrow-down-circle" viewBox="0 0 18 18" style="fill: white;">
                                            <path fill-rule="evenodd"
                                                d="M1 8a7 7 0 1 0 14 0A7 7 0 0 0 1 8m15 0A8 8 0 1 1 0 8a8 8 0 0 1 16 0M8.5 4.5a.5.5 0 0 0-1 0v5.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293z" />
                                        </svg> Generate PDF
                                    </a>
                                    {% endif %}
                                    <!-- Add Credit Note Button -->
                                    <button class="btn btn-primary btn-sm a-btn gap-1" type="button"
                                        id="addCreditNoteButton-{{ invoice.id }}" data-bs-toggle="modal"
                                        data-bs-target="#addCreditNoteModal-{{ invoice.id }}">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="15" height="15" fill="white"
                                            class="bi bi-plus-circle" viewBox="0 0 18 18" style="fill: white;">
                                            <path
                                                d="M8 1a7 7 0 1 1 0 14A7 7 0 0 1 8 1zm0 1a6 6 0 1 0 0 12A6 6 0 0 0 8 2z" />
                                            <path
                                                d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z" />
                                        </svg>CR
                                    </button>
                                    {% else %}
                                    <span class="status pending">pending</span>
                                    {% endif %}
                                    {% endwith %}
                                </div>

                            </td>
                        </tr>



                        <!-- Add Credit Note Modal -->
                        <div class="modal fade" id="addCreditNoteModal-{{ invoice.id }}" tabindex="-1"
                            aria-labelledby="addCreditNoteModalLabel-{{ invoice.id }}" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-centered custom-modal-width">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="addCreditNoteModalLabel-{{ invoice.id }}">Add
                                            Credit Note</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"
                                            aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <form id="addCreditNoteForm-{{ invoice.id }}" method="POST"
                                            action="{% url 'sales_items:sales_items_create_note' organization.id invoice.id  %}">
                                            {% csrf_token %}
                                            <div id="cr-form-errors-{{ invoice.id }}" class="alert alert-danger d-none">
                                                <!-- Error messages will be inserted here -->
                                            </div>
                                            <div class="row gap-3">
                                                <!-- Customer Details -->
                                                <div class="col-md-3">
                                                    <div class="col">
                                                        <label for="customerName-{{ invoice.id }}"
                                                            class="form-label">Customer Name</label>
                                                        <input type="text" id="customerName-{{ invoice.id }}"
                                                            class="form-control" name="customer_name"
                                                            value="{{ invoice.customer.customer_name|default:'' }}"
                                                            readonly>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label for="customerPhone-{{ invoice.id }}"
                                                            class="form-label">Customer Phone</label>
                                                        <input type="text" id="customerPhone-{{ invoice.id }}"
                                                            class="form-control" name="customer_phone"
                                                            value="{{ invoice.customer.customer_phone|default:'' }}"
                                                            readonly>
                                                    </div>

                                                    <div class="mb-3">
                                                        <label for="customerEmail-{{ invoice.id }}"
                                                            class="form-label">Customer Email</label>
                                                        <input type="text" id="customerEmail-{{ invoice.id }}"
                                                            class="form-control" name="customer_email"
                                                            value="{{ invoice.customer.customer_email|default:'' }}"
                                                            readonly>
                                                    </div>
                                                </div>

                                                <div class="col-md-5">
                                                    <!-- Item Details -->
                                                    {% for sales_item in invoice.sales_items.all %}
                                                    <div class="row justify-content-between">
                                                        <div class="col-md-5">
                                                            <label for="itemDetails-{{ invoice.id }}"
                                                                class="form-label">Item Details</label>
                                                            <input type="text" id="itemDetails-{{ invoice.id }}"
                                                                class="form-control"
                                                                value="{{ sales_item.item.item_name }}" readonly>
                                                            <input type="text"
                                                                id="salesItemId-{{ invoice.id }}-{{ sales_item.id }}"
                                                                class="form-control" value="{{ sales_item.id }}"
                                                                name="salesItemId" hidden>
                                                        </div>

                                                        <!-- Editable Quantity -->
                                                        <div class="col-md-6">
                                                            <label for="creditNoteQuantity-{{ invoice.id }}"
                                                                class="form-label">Quantity</label>
                                                            <input type="number"
                                                                id="creditNoteQuantity-{{ invoice.id }}"
                                                                name="credit_note_quantity" class="form-control" min="1"
                                                                max="{{ sales_item.qty }}" value="0" required>
                                                            <small class="form-text text-muted">Max allowed:
                                                                {{ sales_item.qty }}</small>
                                                        </div>


                                                    </div>
                                                    {% endfor %}
                                                </div>

                                                <div class="col-md-3">
                                                    <!-- Reason Selection - Only One Place -->
                                                    <div>
                                                        <label for="creditNoteReason-{{ invoice.id }}"
                                                            class="form-label">Reason</label>
                                                        <select id="creditNoteReason-{{ invoice.id }}"
                                                            name="credit_note_reason" class="form-select" required>
                                                            <option value="refund">Refund</option>
                                                            <option value="replace">Replace</option>
                                                            <option value="exchange">Exchange</option>
                                                            <option value="defective">Defective</option>
                                                            <option value="other">Other</option>
                                                        </select>
                                                    </div>

                                                </div>
                                            </div>


                                            <!-- Modal Footer -->
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary cancel"
                                                    data-bs-dismiss="modal">Cancel</button>
                                                <button type="submit" onclick="submitCrForm(event, '{{invoice.id}}')"
                                                    class="btn btn-primary w-btn">Add Credit
                                                    Note</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p>No sales found for this organization.</p>
                {% endif %}
            </div>

            <!-- credit-note tab -->
            <div class="tab-pane fade" id="credit-note" role="tabpanel" aria-labelledby="credit-note-tab">
                <h3></h3>
                <div class="d-flex justify-content-between align-items-center p-0 pt-1">
                    <h3><span style="color: #000000;">{{ credit_notes.count }}</span> Credit notes</h3>

                </div>
                <hr class="hr-style" />
                <ul class="list-group sales-list"></ul>
                {% if credit_notes %}
                <table class="table table-striped">
                    <thead class="thead-dark">
                        <tr>
                            <th scope="col">#</th>
                            <th scope="col">CR No</th>
                            <th scope="col">Cust Pin</th>
                            <th scope="col">Cust Name</th>
                            <th scope="col">Cust Phone</th>
                            <th scope="col">Cr Reason</th>
                            <th scope="col">Status</th>
                            <th scope="col">Download</th>
                        </tr>

                    </thead>
                    <tbody>
                        {% for credit_note in credit_notes %}
                        <tr id="credit_note-{{ credit_note.id }}" class="align-items-center justify-center lines">
                            <td>{{forloop.counter}}</td>
                            <td>{{ credit_note.receipt_number }}</td>
                            <td>{{ credit_note.customer.customer_pin }}</td>
                            <td>
                                <strong>{{ credit_note.customer.customer_name }}</strong>
                            </td>
                            <td>{{ credit_note.customer.customer_phone }}</td>
                            <td>{{ credit_note.reason }}</td>
                            <td class="dflex">
                                {% with transaction_data=transaction_statuses|dict_get:credit_note.id %}
                                <span class="status {{ transaction_data.status }}">{{ transaction_data.status }}</span>
                                {% if transaction_data.status == "failed" %}
                                <button class="btn retry-request r-btn" data-type="saveTransaction"
                                    data-url="{% url 'organization:retry_failed_request' 'saveTransaction' credit_note.id %}"
                                    data-id="{{ transaction_data.id }}">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="15" height="15" fill="transparent"
                                        class="bi bi-repeat" viewBox="0 0 20 20">
                                        <path
                                            d="M11 5.466V4H5a4 4 0 0 0-3.584 5.777.5.5 0 1 1-.896.446A5 5 0 0 1 5 3h6V1.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384l-2.36 1.966a.25.25 0 0 1-.41-.192m3.81.086a.5.5 0 0 1 .67.225A5 5 0 0 1 11 13H5v1.466a.25.25 0 0 1-.41.192l-2.36-1.966a.25.25 0 0 1 .41-.192V12h6a4 4 0 0 0 3.585-5.777.5.5 0 0 1 .225-.67Z" />
                                    </svg>
                                </button>
                                {% endif %}
                                {% endwith %}
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    {% with transaction_data=transaction_statuses|dict_get:credit_note.id %}
                                    {% if transaction_data.status == "success" %}

                                    {% if credit_note.document_path %}
                                    <button class="btn btn-secondary btn-sm a-btn me-2 view-pdf-btn gap-1"
                                        data-pdf-url="{{ credit_note.document_path.url }}" data-bs-toggle="modal"
                                        data-bs-target="#pdfModal">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="15" height="15" fill="white"
                                            class="bi bi-arrow-down-circle" viewBox="0 0 20 20" style="fill: white;">
                                            <path fill-rule="evenodd"
                                                d="M1 8a7 7 0 1 0 14 0A7 7 0 0 0 1 8m15 0A8 8 0 1 1 0 8a8 8 0 0 1 16 0M8.5 4.5a.5.5 0 0 0-1 0v5.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293z" />
                                        </svg> View PDF
                                    </button>
                                    {% else %}
                                    <a href="{% url 'sales_items:generate_credit_note_pdf' transaction_data.id credit_note.id %}"
                                        class="btn btn-secondary btn-sm w-btn me-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="15" height="15" fill="white"
                                            class="bi bi-arrow-down-circle" viewBox="0 0 20 20" style="fill: white;">
                                            <path fill-rule="evenodd"
                                                d="M1 8a7 7 0 1 0 14 0A7 7 0 0 0 1 8m15 0A8 8 0 1 1 0 8a8 8 0 0 1 16 0M8.5 4.5a.5.5 0 0 0-1 0v5.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293z" />
                                        </svg> Generate PDF
                                    </a>
                                    {% endif %}
                                    {% else %}
                                    <span class="status pending">pending</span>
                                    {% endif %}
                                    {% endwith %}
                                </div>
                            </td>
                        </tr>



                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p>No Credit notes found for this organization.</p>
                {% endif %}
            </div>

            <!-- Purchases tab -->
            <div class="tab-pane fade " id="purchases" role="tabpanel" aria-labelledby="purchases-tab">
                <h3></h3>
                <div class="d-flex justify-content-between align-items-center p-0 pt-1">
                    <h3><span style="color: #000000;">{{ purchases.count }}</span> Purchases</h3>
                    <div>
                        <button data-url="{% url 'organization:update_purchases_view' organization.id %}" type="button"
                            class="btn add purchase-request">
                            Update Items
                        </button>
                    </div>
                </div>
                <hr class="hr-style" />
                <ul class="list-group purchases-list"></ul>
                {% if purchases %}
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>InvNo.</th>
                            <th>Supplier Name</th>
                            <th>Supplier TIN</th>
                            <th>Confirmation Date</th>
                            <th>Total Amount</th>
                            <th>Items</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for purchase in purchases %}
                        <tr>
                            <td>{{ forloop.counter }}</td>
                            <td>{{ purchase.invoice_number }}</td>
                            <td>{{ purchase.supplier_name }}</td>
                            <td>{{ purchase.supplier_tin }}</td>
                            <td>{{ purchase.confirmation_date }}</td>
                            <td>KES {{ purchase.total_amount|floatformat:2 }}</td>
                            <td>
                                <button class="btn btn-sm view-items-btn" data-items="{{ purchase.items|escapejs }}"
                                    data-bs-toggle="modal" data-bs-target="#purchaseModal-{{purchase.invoice_number}}"
                                    data-modal-id="purchaseModalBody-{{ purchase.invoice_number }}">
                                    View Items
                                </button>
                                <!-- Modal for Viewing Items -->
                                <div class="modal fade" id="purchaseModal-{{purchase.invoice_number}}" tabindex="-1"
                                    aria-labelledby="purchaseModalLabel-{{purchase.invoice_number}}" aria-hidden="true">
                                    <div class="modal-dialog modal-lg modal-dialog-centered">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="itemsModalLabel">
                                                    #{{purchase.invoice_number}} - Purchase Items</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                    aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                <div>
                                                    <button type="button" class="btn add" data-toggle="modal"
                                                        data-bs-toggle="modal"
                                                        data-bs-target="#addPurchaseItemsModal-{{ purchase.invoice_number }}"
                                                        data-modal-id="addPurchaseItemsModal-{{ purchase.invoice_number }}">
                                                        + Add Items
                                                    </button>
                                                </div>
                                                {% include "organization/invoice_template.html" with purchase=purchase%}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Add Purchase Items Modal -->
                                <div class="modal fade" id="addPurchaseItemsModal-{{ purchase.invoice_number }}"
                                    tabindex="-1" aria-labelledby="addItemsModalLabel-{{ purchase.invoice_number }}"
                                    aria-hidden="true" data-bs-backdrop="static">
                                    <div class="modal-dialog modal-lg modal-dialog-centered">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title"
                                                    id="addItemsModalLabel-{{ purchase.invoice_number }}">
                                                    Create items from Purchase Invoice
                                                    {{ purchase.invoice_number }}
                                                </h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                    aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                <ul class="nav nav-tabs" id="addItemsTabs-{{ purchase.invoice_number }}"
                                                    role="tablist">
                                                    <li class="nav-item" role="presentation">
                                                        <button class="nav-link active"
                                                            id="create-items-tab-{{ purchase.invoice_number }}"
                                                            data-bs-toggle="tab"
                                                            data-bs-target="#create-items-{{ purchase.invoice_number }}"
                                                            type="button" role="tab" aria-controls="create-items"
                                                            aria-selected="true">Create Item(s)</button>
                                                    </li>
                                                    <li class="nav-item" role="presentation">
                                                        <button class="nav-link"
                                                            id="add-existing-tab-{{ purchase.invoice_number }}"
                                                            data-bs-toggle="tab"
                                                            data-bs-target="#add-existing-{{ purchase.invoice_number }}"
                                                            type="button" role="tab" aria-controls="add-existing"
                                                            aria-selected="false">Add to Existing
                                                            Item(s)</button>
                                                    </li>
                                                </ul>
                                                <div class="tab-content mt-3"
                                                    id="addItemsTabsContent-{{ purchase.invoice_number }}">
                                                    <!-- Create Items Tab -->
                                                    <div class="tab-pane fade show active"
                                                        id="create-items-{{ purchase.invoice_number }}" role="tabpanel"
                                                        aria-labelledby="create-items-tab-{{ purchase.invoice_number }}">
                                                        <form>
                                                            <table class="table">
                                                                <thead>
                                                                    <tr>
                                                                        <th>Item Name</th>
                                                                        <th>Quantity</th>
                                                                        <th>Unit Price</th>
                                                                        <th>Create Item?</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody
                                                                    id="create-items-body-{{ purchase.invoice_number }}"
                                                                    action="{% url 'item:create_items_from_purchase' organization.id %}">
                                                                    {% for item in purchase.items %}
                                                                    <tr>
                                                                        <td data-attr="{{item}}">{{ item.itemNm }}</td>
                                                                        <td>{{ item.qty }}</td>
                                                                        <td>{{ item.prc }}</td>
                                                                        <td><input type="checkbox"
                                                                                name="stock-item-{{ forloop.counter }}">
                                                                        </td>
                                                                    </tr>
                                                                    {% endfor %}
                                                                </tbody>
                                                            </table>

                                                            <div class="text-end">
                                                                <button type="button" class="btn cancel"
                                                                    data-bs-dismiss="modal">Cancel</button>
                                                                <form method="POST"
                                                                    id="createItemStockForm-{{ purchase.invoice_number }}">
                                                                    {% csrf_token %}
                                                                    &nbsp;
                                                                    <button type="submit" class="btn w-btn"
                                                                        onclick="submitCreateItemStockForm(event, '{{purchase.invoice_number}}')">
                                                                        Create Items</button>
                                                                </form>
                                                            </div>
                                                        </form>
                                                    </div>

                                                    <!-- Add to Existing Items Tab -->
                                                    <div class="tab-pane fade"
                                                        id="add-existing-{{ purchase.invoice_number }}" role="tabpanel"
                                                        aria-labelledby="add-existing-tab-{{ purchase.invoice_number }}">
                                                        <form>
                                                            <table class="table">
                                                                <thead>
                                                                    <tr>
                                                                        <th>Item Name</th>
                                                                        <th>Quantity</th>
                                                                        <th>Map to Item</th>
                                                                        <th>Deselect</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody
                                                                    id="existing-items-body-{{ purchase.invoice_number }}"
                                                                    action="{% url 'item:update_mapped_item_quantity' %}">
                                                                    {% for item in purchase.items %}
                                                                    <tr>
                                                                        <td data-attr="{{item}}">{{ item.itemNm }}</td>
                                                                        <td>{{ item.qty }}</td>
                                                                        <td>
                                                                            <select class="form-control"
                                                                                id="select-{{ forloop.counter }}"
                                                                                name="map-to-item-{{ forloop.counter }}">
                                                                                <option value="">Select...</option>
                                                                                {% for existing_item in items %}
                                                                                <option value="{{ existing_item.id }}">
                                                                                    {{ existing_item.item_name}}
                                                                                </option>
                                                                                {% endfor %}
                                                                            </select>
                                                                        </td>
                                                                        <td>
                                                                            <button type="button"
                                                                                class="btn  btn-warning warning"
                                                                                onclick="resetSelection('{{ forloop.counter }}')">
                                                                                Reset
                                                                            </button>
                                                                        </td>
                                                                    </tr>
                                                                    {% endfor %}
                                                                </tbody>
                                                            </table>
                                                            <div class="text-end">
                                                                <button type="button" class="btn cancel"
                                                                    data-bs-dismiss="modal">Cancel</button>
                                                                &nbsp;
                                                                &nbsp;
                                                                <button type="submit" class="btn w-btn"
                                                                    onclick="submitUpdateItemStockForm(event, '{{purchase.invoice_number}}')">
                                                                    Add Stock</button>
                                                            </div>
                                                        </form>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td class="dflex">
                                {% if not purchase.verified %}
                                {% with purchases_data=purchases_statuses|dict_get_p:purchase.id %}
                                <span class="status {{ purchases_data.status }}">{{ purchases_data.status }}</span>

                                {% if purchases_data.status == "failed"%}
                                <button class="btn retry-request r-btn" data-type="verifyPurchase"
                                    data-url="{% url 'organization:retry_failed_request' 'verifyPurchase' purchase.id %}"
                                    data-id="{{ purchases_data.id }}">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="15" height="15" fill="currentColor"
                                        class="bi bi-repeat" viewBox="0 0 20 20">
                                        <path
                                            d="M11 5.466V4H5a4 4 0 0 0-3.584 5.777.5.5 0 1 1-.896.446A5 5 0 0 1 5 3h6V1.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384l-2.36 1.966a.25.25 0 0 1-.41-.192m3.81.086a.5.5 0 0 1 .67.225A5 5 0 0 1 11 13H5v1.466a.25.25 0 0 1-.41.192l-2.36-1.966a.25.25 0 0 1 .41.192V12h6a4 4 0 0 0 3.585-5.777.5.5 0 0 1 .225-.67Z" />
                                    </svg>
                                </button>
                                {% elif purchases_data.status == "Not verified" %}
                                <button class="btn verify-request r-btn" data-type="verifyPurchase"
                                    data-url="{% url 'organization:verify_purchase' 'verifyPurchase' purchase.invoice_number purchase.id  %}"
                                    data-id="{{ purchase.imvoice_number }}">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="15" height="15" fill="currentColor"
                                        class="bi bi-repeat" viewBox="0 0 20 20">
                                        <path
                                            d="M11 5.466V4H5a4 4 0 0 0-3.584 5.777.5.5 0 1 1-.896.446A5 5 0 0 1 5 3h6V1.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384l-2.36 1.966a.25.25 0 0 1-.41-.192m3.81.086a.5.5 0 0 1 .67.225A5 5 0 0 1 11 13H5v1.466a.25.25 0 0 1-.41.192l-2.36-1.966a.25.25 0 0 1 .41.192V12h6a4 4 0 0 0 3.585-5.777.5.5 0 0 1 .225-.67Z" />
                                    </svg>
                                </button>
                                {% else %}

                                {% endif %}
                                {% endwith %}

                                {% else %}
                                <span class="status success">
                                    Verified
                                </span>
                                {% endif %}

                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>

                {% else %}
                <p>No purchases found for this organization.</p>
                {% endif %}

            </div>
        </div>
    </div>
</div>

<!-- Customer Creation Modal -->
<div class="modal fade" id="createCustomerModal" tabindex="-1" aria-labelledby="customerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered  modal-part">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="customerModalLabel">Add Customer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body  p-4">
                <form method="POST" id="customerForm" action="{%  url 'customer:customer_create' organization.id %}">
                    <div id="cust-form-errors" class="alert alert-danger d-none">
                        <!-- Error messages will be inserted here -->
                    </div>
                    {% csrf_token %}
                    <input type="hidden" name="action_name" value="create_customer">
                    {{ form.media }}
                    {% bootstrap_form customer_form %}
                    <div class="text-center">
                        <button type="submit" class="mt-3 btn btn-danger btn-sm w-btn">Save Customer</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>


<!-- Bootstrap Modal for Viewing PDF -->
<div class="modal fade" id="pdfModal" tabindex="-1" aria-labelledby="pdfModalLabel" aria-hidden="true">
    <div class="modal-dialog ">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="pdfModalLabel">PDF Viewer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- PDF Viewer -->
                <iframe id="pdfIframe" style="width:100%; height:500px;" frameborder="0"></iframe>
            </div>
            <div class="modal-footer">
                <a id="downloadPdfBtn" href="#" class="btn btn-primary a-btn" download>Download PDF</a>
                <button type="button" class="btn btn-secondary a-btn" id="printPdfBtn">Print PDF</button>
            </div>
        </div>
    </div>
</div>

<!-- Item Creation Modal -->
<div class="modal fade" id="createItemModal" tabindex="-1" aria-labelledby="itemModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered  modal-part">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="itemModalLabel">Add Item</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <form method="POST" id="itemForm" action="{% url 'item:item_create' organization.id %}">
                    <div id="item-form-errorss" class="alert alert-danger d-none">
                        <!-- Error messages will be inserted here -->
                    </div>
                    {% csrf_token %}
                    <input type="hidden" name="action_name" value="create_item">


                    {{ form.media }}

                    <div class="form-row">
                        {% for field in item_form %}
                        {% if forloop.counter0|divisibleby:2 %}
                        <!-- Start a new row for every pair of fields -->
                        <div class="row">
                            {% endif %}

                            <div class="col-md-6">
                                {% bootstrap_field field %}
                            </div>

                            {% if forloop.counter|divisibleby:2 or forloop.last %}
                        </div> <!-- End of row -->
                        {% endif %}
                        {% endfor %}
                    </div>

                    <div class="text-center">
                        <button type="submit" class="mt-3 btn btn-danger btn-sm w-btn">Save Item</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>


{% block javascript %}
<script>
    $(document).ready(function () {
        console.log("Initializing Select2 for id_quantity_unit_code...");

        // Ensure jQuery is loaded before Select2
        if (!$.fn.select2) {
            console.error("Select2 is not loaded properly!");
            return;
        }

        // Get the Select2 field
        const quantity_unit_code = $("#id_dquantity_unit_code");

        if (quantity_unit_code.length > 0) {
            const dataUrl = quantity_unit_code.attr("data-autocomplete-light-url");

            if (dataUrl) {
                console.log("Initializing Select2 with AJAX for id_quantity_unit_code...");

                quantity_unit_code.select2({
                    placeholder: "Select a unit code",
                    dropdownAutoWidth: true,
                    ajax: {
                        url: dataUrl,
                        dataType: 'json',
                        delay: 250,
                        processResults: function (data) {
                            console.log("Processing AJAX results...");
                            return {
                                results: data.results
                            };
                        },
                        cache: true
                    },
                    minimumInputLength: 1
                });
            } else {
                console.log("No data-autocomplete-light-url found. Initializing Select2 without AJAX.");
                quantity_unit_code.select2({
                    placeholder: "Select a unit code"
                });
            }
        } else {
            console.log("id_quantity_unit_code not found.");
        }

        // Fix Select2 inside Bootstrap modal
        $('#createItemModal').on('shown.bs.modal', function () {
            console.log("Modal opened. Re-initializing Select2...");
            quantity_unit_code.select2({
                dropdownParent: $("#createItemModal") // Ensures Select2 works inside the modal
            });

            // Delay focus to prevent Bootstrap stealing focus
            setTimeout(function () {
                let searchField = document.querySelector('.select2-container--open .select2-search__field');
                if (searchField) {
                    console.log("Focusing on Select2 search field...");
                    searchField.focus();
                }
            }, 200);
        });

        // Reinitialize Select2 when switching Bootstrap tabs
        $('a[data-bs-toggle="tab"]').on("shown.bs.tab", function () {
            console.log("Tab switched. Re-initializing Select2...");
            quantity_unit_code.select2();
        });

        // Detect dynamically added elements and initialize Select2
        $(document).on('DOMNodeInserted', function (e) {
            if ($(e.target).is("#id_quantity_unit_code")) {
                console.log("New Select2 element detected. Initializing...");
                $(e.target).select2();
            }
        });
    });

</script>
{% endblock javascript %}


<!-- Scripts-->
<script>
    function showToast(message) {
        alert(message);
    }

    function resetSelection(rowId) {
        // Get the `select` element for the given row
        const selectField = document.getElementById(`select-${rowId}`);
        console.log(selectField);
        if (selectField) {
            selectField.value = "";
        }
    }

    document.addEventListener("DOMContentLoaded", function () {
        // Listen for modal show events
        document.querySelectorAll(".modal").forEach((modal) => {
            modal.addEventListener("show.bs.modal", function () {
                const openModals = document.querySelectorAll(".modal.show").length;

                // Adjust z-index of the current modal to stack properly
                const modalDialog = this.querySelector(".modal-dialog");
                if (modalDialog) {
                    modalDialog.style.zIndex = 1040 + (openModals + 1) * 10;
                }

                // Adjust the backdrop for stacking
                const modalBackdrop = document.createElement("div");
                modalBackdrop.className = "modal-backdrop fade show";
                modalBackdrop.style.zIndex = 1039 + (openModals + 1) * 10;
                document.body.appendChild(modalBackdrop);
            });

            // Listen for modal hide events
            modal.addEventListener("hidden.bs.modal", function () {
                // Remove the last backdrop when the top modal is closed
                const openModals = document.querySelectorAll(".modal.show").length;
                if (openModals === 0) {
                    document.querySelectorAll(".modal-backdrop").forEach((backdrop) => {
                        backdrop.remove();
                    });
                }
            });
        });
    });

    document.addEventListener("DOMContentLoaded", function () {
        // Select all "View PDF" buttons
        const viewPdfBtns = document.querySelectorAll(".view-pdf-btn");

        // Modal Elements
        const pdfIframe = document.getElementById("pdfIframe");
        const downloadPdfBtn = document.getElementById("downloadPdfBtn");
        const printPdfBtn = document.getElementById("printPdfBtn");

        // Function to handle viewing the PDF
        viewPdfBtns.forEach((btn) => {
            btn.addEventListener("click", function () {
                // Get the PDF URL from the button's data attribute
                const pdfUrl = this.getAttribute("data-pdf-url");

                // Check if the URL is valid
                if (!pdfUrl) {
                    console.error("PDF URL is missing.");
                    return;
                }

                // Update iframe source to display the PDF
                if (pdfIframe) {
                    pdfIframe.setAttribute("src", pdfUrl);
                } else {
                    console.error("PDF iframe element is not found.");
                }

                // Update the download link for the PDF
                if (downloadPdfBtn) {
                    downloadPdfBtn.setAttribute("href", pdfUrl);
                } else {
                    console.error("Download button element is not found.");
                }
            });
        });

        // Function to handle printing the PDF
        if (printPdfBtn) {
            printPdfBtn.addEventListener("click", function () {
                if (pdfIframe) {
                    const iframeWindow = pdfIframe.contentWindow || pdfIframe;
                    if (iframeWindow) {
                        iframeWindow.focus();
                        iframeWindow.print();
                    } else {
                        console.error("Unable to access iframe content for printing.");
                    }
                } else {
                    console.error("PDF iframe element is not found.");
                }
            });
        } else {
            console.error("Print button element is not found.");
        }
    });



    function submitUpdateItemStockForm(event, purchaseNumber) {
        event.preventDefault();

        // Get the table body containing the item rows
        const tableBody = document.getElementById(`existing-items-body-${purchaseNumber}`);
        console.log(`updateItemStockForm-${purchaseNumber}`)

        const actionUrl = tableBody.getAttribute("action");
        // const csrf = tableBody.getAttribute("data-attr");

        console.log(actionUrl);

        // Collect all rows and structure the data
        const items = [];
        Array.from(tableBody.querySelectorAll("tr")).forEach((row) => {
            const itemName = row.cells[0].innerText.trim();
            const quantity = row.cells[1].innerText.trim();
            const mapToItemSelect = row.querySelector('select');

            if (mapToItemSelect && mapToItemSelect.value) {
                items.push({
                    item_name: itemName,
                    quantity: parseFloat(quantity),
                    mapped_item_id: mapToItemSelect.value,
                });
            }
        });

        if (items.length === 0) {
            alert("Please map at least one item to proceed.");
            return;
        }

        // Prepare the payload
        const payload = {
            purchase_number: purchaseNumber,
            mapped_items: items,
        };

        console.log("Payload:", payload); // Debugging: log payload before sending

        // Send the data to the backend
        fetch(actionUrl, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                'X-CSRFToken': getCsrfToken(),
            },
            body: JSON.stringify(payload),
        })
            .then((response) => response.json())
            .then((data) => {
                if (data.success) {
                    window.location.reload();
                }
            })
            .catch((error) => {
                console.error("Error retrying request:", error);
            });
    }

    function submitCreateItemStockForm(event, purchaseNumber) {
        event.preventDefault();

        // Get the table body containing the item rows
        const tableBody = document.getElementById(`create-items-body-${purchaseNumber}`);
        const actionUrl = tableBody.getAttribute("action");

        // Collect all rows and structure the data
        const items = [];
        Array.from(tableBody.querySelectorAll("tr")).forEach((row, index) => {
            const itemDataAttr = row.cells[0].getAttribute("data-attr");
            const createItemCheckbox = row.querySelector(`input[name="stock-item-${index + 1}"]`);

            if (createItemCheckbox && createItemCheckbox.checked) {
                items.push({
                    item: itemDataAttr,
                });
            }
        });

        if (items.length === 0) {
            alert("Please select at least one item to create.");
            return;
        }

        // Prepare the payload
        const payload = {
            purchase_number: purchaseNumber,
            items: items,
        };

        console.log("Payload for creating items:", payload, actionUrl);

        // Send the data to the backend
        fetch(actionUrl, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": document.querySelector('[name="csrfmiddlewaretoken"]').value,
            },
            body: JSON.stringify(payload),
        }).then((response) => response.json())
            .then((data) => {
                if (data.success) {
                    window.location.reload();
                }
            })
            .catch((error) => {
                console.error("Error retrying request:", error);
            });
    }


    // Utility function to get the CSRF token from the page
    function getCsrfToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]').value;
    }


    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll(".retry-request").forEach((button) => {
            button.addEventListener("click", function () {
                const requestType = this.getAttribute("data-type");
                const requestId = this.getAttribute("data-id");
                const dataUrl = this.getAttribute("data-url");

                fetch(dataUrl, {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": "{{ csrf_token }}",
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        log_id: requestId
                    }),
                })
                    .then((response) => response.json())
                    .then((data) => {
                        if (data.success) {
                            window.location.reload();
                        }
                    })
                    .catch((error) => {
                        console.error("Error retrying request:", error);
                    });
            });
        });
    });

    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll(".purchase-request").forEach((button) => {
            button.addEventListener("click", function () {
                const dataUrl = this.getAttribute("data-url");
                const DISABLE_MINUTES = 5;
                const disableMs = DISABLE_MINUTES * 60 * 1000;

                // If you have multiple, consider unique IDs, e.g. `purchaseRequestLastClicked_<some_id>`.
                const storageKey = "purchaseRequestLastClicked";

                // Check if we have a previous timestamp
                const lastClickedTime = localStorage.getItem(storageKey);
                const currentTime = Date.now();

                // If the last clicked time exists and is within 5 minutes, disable the button
                if (lastClickedTime && currentTime - lastClickedTime < disableMs) {
                    button.disabled = true;
                    button.textContent = "Updating...";
                    return
                }
                console.log(disableMs);
                fetch(dataUrl, {
                    method: "GET",
                    headers: {
                        "X-CSRFToken": "{{ csrf_token }}",
                    },
                })
                    .then((response) => response.json())
                    .then((data) => {
                        if (data.success) {
                            // 1) Show a toast
                            showToast("Update in progress...");

                            // 2) Change the text and disable the button
                            button.textContent = "Updating...";
                            button.disabled = true;

                            // 3) Store the current timestamp in localStorage
                            localStorage.setItem(storageKey, new Date().getTime());

                            console.log(data)
                            // window.location.reload();
                        }
                    })
                    .catch((error) => {
                        console.error("Error retrying request:", error);
                    });
            });
        });
    });


    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll(".verify-request").forEach((button) => {
            button.addEventListener("click", function () {
                const requestType = this.getAttribute("data-type");
                const requestId = this.getAttribute("data-id");
                const dataUrl = this.getAttribute("data-url");

                fetch(dataUrl, {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": "{{ csrf_token }}",
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        invoice_number: requestId
                    }),
                })
                    .then((response) => response.json())
                    .then((data) => {
                        if (data.success) {
                            window.location.reload();
                        }
                    })
                    .catch((error) => {
                        console.error("Error verifyinging request:", error);
                    });
            });
        });
    });

    document.addEventListener("DOMContentLoaded", function () {
        const movementTypeSelect = document.getElementById("movementType");
        const movementReasonSelect = document.getElementById("movementReason");

        const reasons = {
            ADD: ["Import", "Stock Movement", "Processing", "Adjustment"],
            REMOVE: ["Stock Movement", "Processing", "Discarding", "Adjustment"],
        };

        movementTypeSelect.addEventListener("change", function () {
            // Clear existing options
            movementReasonSelect.innerHTML = '<option value="">-- Select Movement Reason --</option>';

            // Get selected type
            const selectedType = movementTypeSelect.value;

            // Populate reasons based on type
            if (selectedType && reasons[selectedType]) {
                reasons[selectedType].forEach(reason => {
                    const option = document.createElement("option");
                    option.value = reason;
                    option.textContent = reason;
                    movementReasonSelect.appendChild(option);
                });
            }
        });
    });


    document.addEventListener('DOMContentLoaded', function () {
        const organizationTab = document.getElementById('organizationTab');
        console.log(organizationTab)
        // Restore active tab from localStorage
        const activeTabId = localStorage.getItem('activeTabId');
        console.log(activeTabId)

        if (activeTabId) {
            const activeTab = document.getElementById(activeTabId);
            if (activeTab) {
                const tabTrigger = new bootstrap.Tab(activeTab);
                tabTrigger.show(); // Activate the stored tab
            }
        }

        // Save the active tab to localStorage on tab change
        organizationTab.addEventListener('shown.bs.tab', function (event) {
            const activeTabId = event.target.id; // ID of the newly activated tab
            localStorage.setItem('activeTabId', activeTabId);
        });
    });

    function submitEditForm(e, customerId) {
        e.preventDefault(); // Prevent default form submission
        const form = document.getElementById(`editForm-${customerId}`);
        const formData = new FormData(form);

        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            },
        })
            .then((response) => {
                if (!response.ok) throw new Error('Failed to submit form.');
                return response.json();
            })
            .then((data) => {
                if (data.success) {
                    window.location.reload();
                } else if (data.errors) {
                    // Show validation errors in the modal
                    console.log('Errors:', data.errors);
                    const errorDiv = document.getElementById('cust-edit-form-errors');
                    errorDiv.classList.remove('d-none'); // Make the error div visible
                    errorDiv.innerHTML = ''; // Clear previous errors

                    // Loop through the errors and display them
                    for (const field in data.errors) {
                        data.errors[field].forEach(error => {
                            const errorMessage = document.createElement('p');
                            errorMessage.textContent = `${error}`;
                            errorDiv.appendChild(errorMessage);
                        });
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // Handle error without alerting
                const errorDiv = document.getElementById('cust-edit-form-errors');
                errorDiv.classList.remove('d-none'); // Make the error div visible
                errorDiv.innerHTML = '<p>An error occurred while saving the customer. Please try again.</p>';
            });
    }

    function submitDeleteForm(e, customerId) {
        e.preventDefault(); // Prevent default form submission
        const form = document.getElementById(`deleteForm-${customerId}`);
        const formData = new FormData(form);

        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            },
        })
            .then((response) => {
                if (!response.ok) throw new Error('Failed to submit form.');
                return response.json();
            })
            .then((data) => {
                if (data.success) {
                    window.location.reload();
                } else if (data.errors) {
                    // Show validation errors in the modal
                    console.log('Errors:', data.errors);
                    const errorDiv = document.getElementById('delete-form-errors');
                    errorDiv.classList.remove('d-none'); // Make the error div visible
                    errorDiv.innerHTML = ''; // Clear previous errors

                    // Loop through the errors and display them
                    for (const field in data.errors) {
                        data.errors[field].forEach(error => {
                            const errorMessage = document.createElement('p');
                            errorMessage.textContent = `${error}`;
                            errorDiv.appendChild(errorMessage);
                        });
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // Handle error without alerting
                const errorDiv = document.getElementById('delete-form-errors');
                errorDiv.classList.remove('d-none'); // Make the error div visible
                errorDiv.innerHTML = '<p>An error occurred while deleting the customer. Please try again.</p>';
            });
    }

    function submitDeleteItemForm(e, itemId) {
        e.preventDefault(); // Prevent default form submission
        const form = document.getElementById(`deleteItemForm-${itemId}`);
        const formData = new FormData(form);

        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            },
        })
            .then((response) => {
                if (!response.ok) throw new Error('Failed to submit form.');
                return response.json();
            })
            .then((data) => {
                if (data.success) {
                    window.location.reload();
                } else if (data.errors) {
                    // Show validation errors in the modal
                    console.log('Errors:', data.errors);
                    const errorDiv = document.getElementById('delete-item-form-errors');
                    errorDiv.classList.remove('d-none'); // Make the error div visible
                    errorDiv.innerHTML = ''; // Clear previous errors

                    // Loop through the errors and display them
                    for (const field in data.errors) {
                        data.errors[field].forEach(error => {
                            const errorMessage = document.createElement('p');
                            errorMessage.textContent = `${error}`;
                            errorDiv.appendChild(errorMessage);
                        });
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // Handle error without alerting
                const errorDiv = document.getElementById('delete-item-form-errors');
                errorDiv.classList.remove('d-none'); // Make the error div visible
                errorDiv.innerHTML = '<p>An error occurred while deleting the item. Please try again.</p>';
            });
    }

    function submitCrForm(e, invoiceId) {
        e.preventDefault(); // Prevent default form submission
        const form = document.getElementById(`addCreditNoteForm-${invoiceId}`);
        const formData = new FormData(form);

        const creditNoteData = {
            customer: {
                name: formData.get('customer_name'),
                phone: formData.get('customer_phone'),
                email: formData.get('customer_email')
            },
            items: []
        };

        const reason = formData.get('credit_note_reason');

        let currentItem = null;
        // Process the form data into the required format
        formData.forEach((value, key) => {
            // Check if the key is related to an item field by looking for 'itemId'
            const salesItemIdMatch = key.match(/salesItemId/);

            if (salesItemIdMatch) {
                // Found an itemId, this indicates a new item starts
                // If there's a current item, push it into the items array
                if (currentItem && parseFloat(currentItem.creditNoteQuantity) >= 1) {
                    creditNoteData.items.push(currentItem);
                }

                // Extract the salesItemId from the key
                const salesItemId = salesItemIdMatch[1];

                // Start a new item object
                currentItem = {
                    salesItemId: salesItemId
                };
            }

            // Add fields related to the current item (excluding customer fields)
            if (currentItem) {
                if (key.startsWith('salesItemId')) {
                    currentItem.salesItemId = value; // Item ID field
                } else if (key.startsWith('credit_note_quantity')) {
                    currentItem.creditNoteQuantity = value; // Credit Note Quantity
                }
                currentItem.creditNoteReason = reason; // Credit Note Reason
            }
        });

        // Push the last item into the items array
        if (currentItem && parseFloat(currentItem.creditNoteQuantity) >= 1) {
            creditNoteData.items.push(currentItem);
        }

        if (creditNoteData.items.length === 0) {
            return;
        }

        // console.log(creditNoteData);

        fetch(form.action, {
            method: 'POST',
            body: JSON.stringify(creditNoteData),
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                'X-Requested-With': 'XMLHttpRequest',
            },
        }).then((response) => {
            if (!response.ok) throw new Error('Failed to submit form.');
            return response.json();
        }).then((data) => {
            console.log(data)
            if (data.success) {
                window.location.reload();
            } else if (data.errors) {
                // Show validation errors in the modal
                console.log('Errors:', data.errors);
                const errorDiv = document.getElementById(`cr-form-errors-${invoiceId}`);
                errorDiv.classList.remove('d-none'); // Make the error div visible
                errorDiv.innerHTML = ''; // Clear previous errors

                // Loop through the errors and display them
                for (const field in data.errors) {
                    data.errors[field].forEach(error => {
                        const errorMessage = document.createElement('p');
                        errorMessage.textContent = `${error}`;
                        errorDiv.appendChild(errorMessage);
                    });
                }
            }
        })
            .catch(error => {
                console.error('Error:', error);
                // Handle error without alerting
                const errorDiv = document.getElementById(`cr-form-errors-${invoiceId}`);
                errorDiv.classList.remove('d-none'); // Make the error div visible
                errorDiv.innerHTML = '<p>An error occurred while saving the item. Please try again.</p>';
            });
    }


    function submitUpdateItemForm(e, itemId) {
        e.preventDefault(); // Prevent default form submission
        const form = document.getElementById(`updateItemForm-${itemId}`);
        const formData = new FormData(form);

        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            },
        })
            .then((response) => {
                if (!response.ok) throw new Error('Failed to submit form.');
                return response.json();
            })
            .then((data) => {
                if (data.success) {
                    window.location.reload();
                } else if (data.errors) {
                    // Show validation errors in the modal
                    console.log('Errors:', data.errors);
                    const errorDiv = document.getElementById('item-edit-form-errors');
                    errorDiv.classList.remove('d-none'); // Make the error div visible
                    errorDiv.innerHTML = ''; // Clear previous errors

                    // Loop through the errors and display them
                    for (const field in data.errors) {
                        data.errors[field].forEach(error => {
                            const errorMessage = document.createElement('p');
                            errorMessage.textContent = `${error}`;
                            errorDiv.appendChild(errorMessage);
                        });
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // Handle error without alerting
                const errorDiv = document.getElementById('item-edit-form-errors');
                errorDiv.classList.remove('d-none'); // Make the error div visible
                errorDiv.innerHTML = '<p>An error occurred while saving the item. Please try again.</p>';
            });
    }

    function formatDate(createdAt) {
        // Check if the input date is valid
        const date = new Date(createdAt);

        // If the date is invalid, return a fallback value
        if (isNaN(date.getTime())) {
            console.error('Invalid date:', createdAt);
            return 'Invalid Date'; // You can customize this fallback
        }

        // If valid, format the date
        const formattedDate = new Intl.DateTimeFormat('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        }).format(date);

        return formattedDate;
    }

    document.getElementById('customerForm').addEventListener('submit', function (e) {
        e.preventDefault(); // Prevent default form submission
        const form = e.target;
        const formData = new FormData(form);
        console.log(form.action);
        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest' // Indicate it's an AJAX request
            }
        })
            .then(response => {
                if (!response.ok) throw new Error('Failed to submit form.');
                return response.json();
            })
            .then(data => {
                if (data.success) {

                    // Append the new customer dynamically to the list
                    const customerList = document.querySelector('.cust-list');
                    const newCustomer = `
                        <tr id="customer-${data.customer_id}" class="align-items-center justify-center lines">
                            <td>{{forloop.counter}}</td>

                            <td class="td-header ">
                                <a class="a-style">
                                    <strong class="td_title">${data.customer_name}</strong><br>
                                    &nbsp;Pin: <small class="td_span">${data.customer_pin}</small>
                                </a>
                            </td>
                            <td>${data.customer_phone}</td>
                            <td>${data.customer_email}</td>
                            <td>${data.customer_address}</td>
                            <td>
                                <div class="dropdown">
                                    <button class="btn btn-secondary btn-sm dropdown-toggle w-btn" type="button"
                                        id="dropdownMenuButton-customer-${data.customer_id}" data-bs-toggle="dropdown"
                                        aria-expanded="false">
                                        Actions
                                    </button>
                                    <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton-customer-${data.customer_id}">
                                       
                                    </ul>
                                </div>
                            </td>
                        </tr>
                        

                        <!-- Edit Modal -->
                        <div class="modal fade" id="editModal-${data.customer_id}" tabindex="-1"
                            aria-labelledby="editModalLabel-${data.customer_id}" aria-hidden="true">
                            <div class="modal-dialog  modal-dialog-centered">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="editModalLabel-${data.customer_id}">Edit Customer</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"
                                            aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <!-- Add edit form here -->
                                        <form id="editForm-${data.customer_id}" method="POST"
                                            action="${data.customer_update_url}">
                                            <div id="form-errors" class="alert alert-danger d-none">
                                                <!-- Error messages will be inserted here -->
                                            </div>
                                            {% csrf_token %}
                                            <div class="mb-3">
                                                <label for="customerName" class="form-label">Customer Name</label>
                                                <input type="text" class="form-control"
                                                    id="customerName-${data.customer_id}" name="customer_name"
                                                    value="${data.customer_name}">
                                            </div>
                                            <div class="mb-3">
                                                <label for="customerEmail" class="form-label">Customer Email</label>
                                                <input type="email" class="form-control"
                                                    id="customerEmail-${data.customer_id}" name="customer_email"
                                                    value="${data.customer_email}">
                                            </div>
                                            <div class="mb-3">
                                                <label for="customerAddress" class="form-label">Customer Address</label>
                                                <input type="text" class="form-control"
                                                    id="customerAddress-${data.customer_id}" name="customer_address"
                                                    value="${data.customer_address}">
                                            </div>
                                            <div class="mb-3">
                                                <label for="customerPhone" class="form-label">Customer Phone</label>
                                                <input type="text" class="form-control"
                                                    id="customerPhone-${data.customer_id}" name="customer_phone"
                                                    value="${data.customer_phone}">
                                            </div>
                                            <div class="text-center">
                                                <button type="button" class="btn btn-primary w-btn"
                                                    onclick="submitEditForm${data.customer_id}">
                                                    Save Changes
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Delete Modal -->
                        <div class="modal fade" id="deleteModal-${data.customer_id}" tabindex="-1"
                            aria-labelledby="deleteModalLabel-${data.customer_id}" aria-hidden="true">
                            <div class="modal-dialog  modal-dialog-centered">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title text-danger" id="deleteModalLabel-${data.customer_id}">
                                            Delete Customer </h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"
                                            aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        Are you sure you want to delete <strong>${data.customer_name}</strong>?
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn cancel" data-bs-dismiss="modal">Cancel</button>
                                        <form method="POST" action="${data.customer_delete_url}">
                                            {% csrf_token %}
                                            <button type="submit" class="btn delete">Delete</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    customerList && customerList.insertAdjacentHTML('beforeend', newCustomer);

                    const closeButton = document.querySelector('.btn-close'); // Close button in the modal
                    if (closeButton) {
                        closeButton.click(); // Simulate click to close modal
                    }
                    // Reset the form and hide the modal
                    form.reset();
                    const modal = bootstrap.Modal.getInstance(document.getElementById('createCustomerModal'));
                    modal.hide();
                    window.location.reload();

                } else if (data.errors) {
                    // Show validation errors in the modal
                    const errorDiv = document.getElementById('cust-form-errors');
                    errorDiv.classList.remove('d-none'); // Make the error div visible
                    errorDiv.innerHTML = ''; // Clear previous errors

                    // Loop through the errors and display them
                    for (const field in data.errors) {
                        data.errors[field].forEach(error => {
                            console.log(error);
                            const errorMessage = document.createElement('p');
                            errorMessage.textContent = `${error}`;
                            errorDiv.appendChild(errorMessage);
                        });
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // Handle error without alerting
                const errorDiv = document.getElementById('cust-form-errors');
                errorDiv.classList.remove('d-none'); // Make the error div visible
                errorDiv.innerHTML = '<p>An error occurred while saving the customer. Please try again.</p>';
            });
    });

    document.getElementById('itemForm').addEventListener('submit', function (e) {
        e.preventDefault(); // Prevent default form submission
        const form = e.target;
        const formData = new FormData(form);

        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest' // Indicate it's an AJAX request
            },
        }).then((response) => {
            if (!response.ok) throw new Error('Failed to submit form.');
            return response.json();
        }).then((data) => {
            if (data.success) {
                window.location.reload();
                // Append the new item dynamically to the list
                const itemList = document.querySelector('.it-list');
                const newItem = `
                     <tr id="item-${data.item_id}" class="align-items-center justify-center lines">
                            <td>{{forloop.counter}}</td>

                            <td class="td-header ">
                                <a class="a-style">
                                    <strong class="td_title">${data.item_name}</strong><br>
                                    &nbsp;Pin: <small class="td_span">${data.item_code}</small>
                                </a>
                            </td>
                            <td>${data.item_type_code}</td>
                            <td>${data.item_class_code}</td>
                            <td>${data.item_tax_code}</td>
                            <td>${data.item_current_balance}</td>
                            <td>
                                <div class="dropdown">
                                    <button class="btn btn-secondary btn-sm dropdown-toggle w-btn" type="button"
                                        id="dropdownMenuButton-item-${data.item_id}" data-bs-toggle="dropdown"
                                        aria-expanded="false">
                                        Actions
                                    </button>
                                    <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton-item-${data.item_id}">
                                       
                                    </ul>
                                </div>
                            </td>
                        </tr>
                        
                    `;
                itemList && itemList.insertAdjacentHTML('beforeend', newItem);

                const closeButton = document.querySelector('.btn-close'); // Close button in the modal
                if (closeButton) {
                    closeButton.click(); // Simulate click to close modal
                }
                form.reset();
                window.location.reload();

            } else if (data.errors) {
                // Show validation errors in the modal
                const errorDiv = document.getElementById('item-form-errorss');
                errorDiv.classList.remove('d-none'); // Make the error div visible
                errorDiv.innerHTML = ''; // Clear previous errors

                // Loop through the errors and display them
                for (const field in data.errors) {
                    data.errors[field].forEach(error => {
                        const errorMessage = document.createElement('p');
                        errorMessage.textContent = `${error}`;
                        errorDiv.appendChild(errorMessage);
                    });
                }
            }
        }).catch(error => {
            console.error('Error:', error);
            // Handle error without alerting
            const errorDiv = document.getElementById('item-form-errorss');
            errorDiv.classList.remove('d-none'); // Make the error div visible
            errorDiv.innerHTML = '<p>An error occurred while saving the item. Please try again.</p>';
        });
    });


    document.addEventListener('DOMContentLoaded', function () {
        const updateQuantityModal = document.getElementById('updateQuantityModal');
        const itemIdInput = document.getElementById('itemId');
        const itemNameInput = document.getElementById('itemName');
        const itemQuantityInput = document.getElementById('itemQuantity');

        updateQuantityModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const itemId = button.getAttribute('data-item-id');
            const itemName = button.getAttribute('data-item-name');
            const itemQuantity = button.getAttribute('data-item-quantity');

            // Populate the modal inputs
            itemIdInput.value = itemId;
            itemNameInput.value = itemName;
            itemQuantityInput.value = itemQuantity;
        });

        // Form submission handling
        const updateQuantityForm = document.getElementById('updateQuantityForm');
        updateQuantityForm.addEventListener('submit', function (e) {
            console.log('<p>An error occurred while loading the item. Please try again.</p>');

            e.preventDefault(); // Prevent default form submission

            const formData = new FormData(updateQuantityForm);

            // Send the form data via AJAX
            fetch(updateQuantityForm.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
                .then(response => {
                    if (!response.ok) throw new Error('Failed to submit form.');
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        window.location.reload();
                    } else if (data.errors) {
                        // Show validation errors in the modal
                        const errorDiv = document.getElementById('item-edit-form-errors');
                        errorDiv.classList.remove('d-none'); // Make the error div visible
                        errorDiv.innerHTML = ''; // Clear previous errors

                        // Loop through the errors and display them
                        for (const field in data.errors) {
                            data.errors[field].forEach(error => {
                                console.log(error);
                                const errorMessage = document.createElement('p');
                                errorMessage.textContent = `${error}`;
                                errorDiv.appendChild(errorMessage);
                            });
                        }
                    }
                }).catch(error => {
                    console.error('Error:', error);
                    // Handle error without alerting
                    const errorDiv = document.getElementById('item-edit-form-errors');
                    errorDiv.classList.remove('d-none'); // Make the error div visible
                    errorDiv.innerHTML = '<p>An error occurred while saving the item. Please try again.</p>';
                });
        });
    });

</script>

{% endblock %}